<script lang="ts">
import { onKeyStroke, useEventListener } from '@vueuse/core'
import { nextTick, onMounted, onUnmounted, ref, useTemplateRef, watch } from 'vue'
import { ACCESS_TOKEN, authExpired } from '@/api'
import API from '@/api/core'
import BoxContainer from '@/components/BoxContainer.vue'
import MessageItem from '@/components/MessageItem.vue'
import { startToolPolling, stopToolPolling, toolMessage } from '@/composables/useToolStatus'
import { CONFIG } from '@/utils/config'
import { live2dState, setEmotion } from '@/utils/live2dController'
import { CURRENT_SESSION_ID, formatRelativeTime, IS_TEMPORARY_SESSION, loadCurrentSession, MESSAGES, newSession, switchSession } from '@/utils/session'
import { isPlaying, speak, stop as stopTTS } from '@/utils/tts'

export function chatStream(content: string, options?: { skill?: string, images?: string[] }) {
  // æ–°é—®ç­”å¼€å§‹æ—¶ï¼Œç«‹å³ä¸­æ­¢ä¸Šä¸€æ¬¡çš„ TTS æ’­æ”¾
  stopTTS()

  MESSAGES.value.push({ role: 'user', content: options?.images?.length ? `[æˆªå›¾x${options.images.length}] ${content}` : content })

  API.chatStream(content, {
    sessionId: CURRENT_SESSION_ID.value ?? undefined,
    disableTTS: true,
    skill: options?.skill,
    images: options?.images,
    temporary: IS_TEMPORARY_SESSION.value || undefined,
  }).then(async ({ sessionId, response }) => {
    if (sessionId) {
      CURRENT_SESSION_ID.value = sessionId
    }
    MESSAGES.value.push({ role: 'assistant', content: '', reasoning: '', generating: true })
    const message = MESSAGES.value[MESSAGES.value.length - 1]!
    // è¿½è¸ªçº¯LLMå†…å®¹ï¼ˆä¸å«å·¥å…·çŠ¶æ€æ ‡è®°ï¼‰ï¼Œç”¨äºTTSæœ—è¯»
    let spokenContent = ''

    live2dState.value = 'thinking'
    let compressTimer: ReturnType<typeof setTimeout> | undefined

    // æƒ…æ„Ÿè§£æå‡½æ•°
    function parseEmotionFromText(text: string): 'normal' | 'positive' | 'negative' | 'surprise' {
      if (text.includes('ã€æ­£é¢æƒ…æ„Ÿã€‘')) {
        return 'positive'
      }
      else if (text.includes('ã€è´Ÿé¢æƒ…æ„Ÿã€‘')) {
        return 'negative'
      }
      else if (text.includes('ã€æƒŠè®¶æƒ…æ„Ÿã€‘')) {
        return 'surprise'
      }
      return 'normal'
    }

    // è®°å½•å½“å‰è½®æ¬¡ content æµçš„èµ·å§‹ä½ç½®ï¼Œcontent_clean åªæ›¿æ¢å½“å‰è½®çš„ LLM è¾“å‡º
    let roundContentStart = 0

    for await (const chunk of response) {
      if (chunk.type === 'reasoning') {
        message.reasoning = (message.reasoning || '') + chunk.text
      }
      else if (chunk.type === 'content') {
        message.content += chunk.text
        spokenContent += chunk.text
        // æ£€æµ‹æƒ…æ„Ÿæ ‡è®°å¹¶è®¾ç½®è¡¨æƒ…
        const emotion = parseEmotionFromText(chunk.text || '')
        if (emotion !== 'normal') {
          void setEmotion(emotion)
        }
      }
      else if (chunk.type === 'content_clean') {
        // ä»…æ›¿æ¢å½“å‰è½®æ¬¡çš„ LLM è¾“å‡ºï¼ˆä» roundContentStart å¼€å§‹ï¼‰ï¼Œä¿ç•™ä¹‹å‰è½®æ¬¡çš„å·¥å…·é€šçŸ¥
        message.content = message.content.substring(0, roundContentStart) + (chunk.text || '')
        spokenContent = chunk.text || ''
      }
      else if (chunk.type === 'tool_calls') {
        // æ˜¾ç¤ºå·¥å…·è°ƒç”¨çŠ¶æ€
        const calls = chunk.calls || []
        const callDesc = calls.map((c: any) => {
          const name = c.service_name || c.agentType || 'tool'
          return `ğŸ”§ ${name}`
        }).join(', ')
        message.content += `\n\n> æ­£åœ¨æ‰§è¡Œå·¥å…·: ${callDesc}...\n`
        // OpenClaw å·¥å…·å¯èƒ½è€—æ—¶è¾ƒé•¿ï¼Œæ·»åŠ æç¤º
        const hasOpenclaw = calls.some((c: any) => {
          const name = (c.service_name || c.agentType || '').toLowerCase()
          return name.includes('openclaw') || name.includes('agent')
        })
        if (hasOpenclaw) {
          message.content += '> â³ OpenClaw å·¥å…·å¤„ç†å¯èƒ½ä¼šæ¯”è¾ƒä¹…ï¼Œé¢„è®¡éœ€è¦ä¸¤åˆ†é’Ÿ\n'
        }
      }
      else if (chunk.type === 'tool_results') {
        // æ˜¾ç¤ºå·¥å…·ç»“æœæ‘˜è¦
        const results = chunk.results || []
        for (const r of results) {
          const status = r.status === 'success' ? 'âœ…' : 'âŒ'
          const label = r.tool_name ? `${r.service_name}: ${r.tool_name}` : r.service_name
          message.content += `\n> ${status} ${label}\n`
        }
        message.content += '\n'
        // å·¥å…·ç»“æœè¿½åŠ å®Œæ¯•ï¼Œæ›´æ–°ä¸‹ä¸€è½® content çš„èµ·å§‹ä½ç½®
        roundContentStart = message.content.length
      }
      else if (chunk.type === 'round_start' && (chunk.round ?? 0) > 1) {
        // å¤šè½®åˆ†éš”
        message.content += '\n---\n\n'
        // æ–°ä¸€è½®å¼€å§‹ï¼Œæ›´æ–° content èµ·å§‹ä½ç½®
        roundContentStart = message.content.length
      }
      else if (chunk.type === 'token_refreshed') {
        // åç«¯åˆ·æ–°äº† tokenï¼ŒåŒæ­¥åˆ°å‰ç«¯ï¼ˆé˜²æ­¢åç»­è½®è¯¢è¯·æ±‚ç”¨æ—§ token è¦†ç›–ï¼‰
        if (chunk.text) {
          ACCESS_TOKEN.value = chunk.text
        }
      }
      else if (chunk.type === 'auth_expired') {
        // åç«¯ LLM è®¤è¯å¤±è´¥ä¸”åˆ·æ–°ä¹Ÿå¤±è´¥ï¼Œè§¦å‘é‡æ–°ç™»å½•
        authExpired.value = true
        message.content += chunk.text || 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•'
      }
      else if (chunk.type === 'compress_start' || chunk.type === 'compress_progress' || chunk.type === 'compress_end') {
        // ä¸Šä¸‹æ–‡å‹ç¼©è¿›åº¦æç¤ºï¼ˆè¦†ç›–å¼æ˜¾ç¤ºï¼Œcompress_end åéé˜»å¡å»¶è¿Ÿæ¸…ç©ºï¼‰
        message.content = `> ${chunk.text}\n\n`
        if (chunk.type === 'compress_end') {
          compressTimer = setTimeout(() => {
            message.content = ''
          }, 1200)
        }
      }
      else if (chunk.type === 'compress_info') {
        // è¿è¡Œæ—¶å‹ç¼©å®Œæˆï¼Œåœ¨å½“å‰ assistant æ¶ˆæ¯å‰æ’å…¥ info æ ‡è®°
        if (compressTimer) {
          clearTimeout(compressTimer)
          compressTimer = undefined
        }
        message.content = ''
        const idx = MESSAGES.value.indexOf(message)
        if (idx > 0) {
          MESSAGES.value.splice(idx, 0, { role: 'info', content: chunk.text || 'ã€å·²å‹ç¼©ä¸Šä¸‹æ–‡ã€‘' })
        }
      }
      // round_end ä¸éœ€è¦ç‰¹æ®Šå¤„ç†
      window.dispatchEvent(new CustomEvent('token', { detail: chunk.text || '' }))
    }

    delete message.generating
    if (!message.reasoning) {
      delete message.reasoning
    }

    if (CONFIG.value.system.voice_enabled && spokenContent) {
      speak(spokenContent).catch(() => {
        live2dState.value = 'idle'
      })
    }
    else {
      live2dState.value = 'idle'
    }
  }).catch((err) => {
    live2dState.value = 'idle'
    MESSAGES.value.push({ role: 'system', content: `Error: ${err.message}` })
  })
}
</script>

<script setup lang="ts">
const input = defineModel<string>()
const containerRef = useTemplateRef('containerRef')
const fileInput = ref<HTMLInputElement | null>(null)

// TTS æ’­æ”¾çŠ¶æ€é©±åŠ¨å˜´éƒ¨åŠ¨ç”»ï¼šå¼€å§‹æ’­æ”¾â†’talkingï¼Œç»“æŸâ†’idle
watch(isPlaying, (playing) => {
  live2dState.value = playing ? 'talking' : 'idle'
})

function scrollToBottom() {
  containerRef.value?.scrollToBottom()
}

function sendMessage() {
  if (input.value) {
    chatStream(input.value)
    nextTick().then(scrollToBottom)
    input.value = ''
  }
}

onMounted(() => {
  loadCurrentSession()
  startToolPolling()
  scrollToBottom()
})
onUnmounted(() => {
  stopToolPolling()
})
useEventListener('token', scrollToBottom)
onKeyStroke('Enter', (e) => {
  if (e.isComposing)
    return
  sendMessage()
})

// Session history
const showHistory = ref(false)
const sessions = ref<Array<{
  sessionId: string
  createdAt: string
  lastActiveAt: string
  conversationRounds: number
  temporary: boolean
}>>([])
const loadingSessions = ref(false)

async function fetchSessions() {
  loadingSessions.value = true
  try {
    const res = await API.getSessions()
    sessions.value = res.sessions ?? []
  }
  catch {
    sessions.value = []
  }
  loadingSessions.value = false
}

function toggleHistory() {
  showHistory.value = !showHistory.value
  if (showHistory.value) {
    fetchSessions()
  }
}

async function handleSwitchSession(id: string) {
  await switchSession(id)
  showHistory.value = false
  nextTick().then(scrollToBottom)
}

async function handleDeleteSession(id: string) {
  try {
    await API.deleteSession(id)
    sessions.value = sessions.value.filter(s => s.sessionId !== id)
    if (CURRENT_SESSION_ID.value === id) {
      newSession()
    }
  }
  catch { /* ignore */ }
}

function handleNewSession() {
  newSession()
  showHistory.value = false
}

function triggerUpload() {
  fileInput.value?.click()
}

async function handleFileUpload(event: Event) {
  const target = event.target as HTMLInputElement
  const file = target.files?.[0]
  if (!file)
    return

  const ext = file.name.split('.').pop()?.toLowerCase()
  const parseable = ['docx', 'xlsx', 'txt', 'csv', 'md']

  if (ext && parseable.includes(ext)) {
    // è§£ææ–‡æ¡£å†…å®¹åå‘é€ç»™æ–‡æœ¬æ¨¡å‹
    MESSAGES.value.push({ role: 'system', content: `æ­£åœ¨è§£ææ–‡ä»¶: ${file.name}...` })
    try {
      const result = await API.parseDocument(file)
      const msg = MESSAGES.value[MESSAGES.value.length - 1]!
      const truncNote = result.truncated ? 'ï¼ˆå†…å®¹è¿‡é•¿ï¼Œå·²æˆªæ–­ï¼‰' : ''
      msg.content = `æ–‡ä»¶è§£æå®Œæˆ: ${file.name}${truncNote}`
      chatStream(`ä»¥ä¸‹æ˜¯æ–‡ä»¶ã€Œ${file.name}ã€çš„å†…å®¹ï¼š\n\n${result.content}\n\nè¯·åˆ†æè¿™ä¸ªæ–‡ä»¶çš„å†…å®¹ã€‚`)
      nextTick().then(scrollToBottom)
    }
    catch (err: any) {
      const msg = MESSAGES.value[MESSAGES.value.length - 1]!
      msg.content = `æ–‡ä»¶è§£æå¤±è´¥: ${err?.response?.data?.detail || err.message}`
    }
  }
  else {
    // å…¶ä»–æ ¼å¼èµ°åŸæœ‰ä¸Šä¼ é€»è¾‘
    MESSAGES.value.push({ role: 'system', content: `æ­£åœ¨ä¸Šä¼ æ–‡ä»¶: ${file.name}...` })
    try {
      const result = await API.uploadDocument(file)
      const msg = MESSAGES.value[MESSAGES.value.length - 1]!
      msg.content = `æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: ${file.name}`
      if (result.filePath) {
        chatStream(`è¯·åˆ†ææˆ‘åˆšä¸Šä¼ çš„æ–‡ä»¶ã€Œ${file.name}ã€ï¼Œæ–‡ä»¶å®Œæ•´è·¯å¾„: ${result.filePath}`)
      }
    }
    catch (err: any) {
      const msg = MESSAGES.value[MESSAGES.value.length - 1]!
      msg.content = `æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ${err.message}`
    }
  }
  target.value = ''
}

// â”€â”€ è¯­éŸ³è¾“å…¥ï¼ˆMediaRecorder + ASR APIï¼‰ â”€â”€
const isRecording = ref(false)
let mediaRecorder: MediaRecorder | null = null
let audioChunks: Blob[] = []

async function toggleVoiceInput() {
  if (isRecording.value) {
    stopVoiceInput()
    return
  }

  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true })
    audioChunks = []
    mediaRecorder = new MediaRecorder(stream, { mimeType: getSupportedMimeType() })

    mediaRecorder.ondataavailable = (e) => {
      if (e.data.size > 0) audioChunks.push(e.data)
    }

    mediaRecorder.onstop = async () => {
      // åœæ­¢æ‰€æœ‰éŸ³è½¨ï¼Œé‡Šæ”¾éº¦å…‹é£
      stream.getTracks().forEach(t => t.stop())
      if (audioChunks.length === 0) return

      const audioBlob = new Blob(audioChunks, { type: mediaRecorder?.mimeType || 'audio/webm' })
      try {
        const { text } = await API.transcribeAudio(audioBlob, { language: 'zh' })
        if (text) input.value += text
      }
      catch (err: any) {
        const status = err?.response?.status
        if (status === 401) {
          MESSAGES.value.push({ role: 'system', content: 'è¯­éŸ³è¯†åˆ«éœ€è¦ç™»å½•åä½¿ç”¨' })
        }
        else if (status === 402) {
          MESSAGES.value.push({ role: 'system', content: 'ä½™é¢ä¸è¶³ï¼Œæ— æ³•ä½¿ç”¨è¯­éŸ³è¯†åˆ«' })
        }
        else {
          MESSAGES.value.push({ role: 'system', content: `è¯­éŸ³è¯†åˆ«å¤±è´¥: ${err.message || err}` })
        }
      }
    }

    mediaRecorder.start()
    isRecording.value = true
  }
  catch (err: any) {
    if (err.name === 'NotAllowedError') {
      MESSAGES.value.push({ role: 'system', content: 'éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼Œè¯·åœ¨ç³»ç»Ÿè®¾ç½®ä¸­å…è®¸éº¦å…‹é£è®¿é—®' })
    }
    else {
      MESSAGES.value.push({ role: 'system', content: `æ— æ³•å¯åŠ¨å½•éŸ³: ${err.message || err}` })
    }
  }
}

function stopVoiceInput() {
  if (mediaRecorder && mediaRecorder.state !== 'inactive') {
    mediaRecorder.stop()
  }
  mediaRecorder = null
  isRecording.value = false
}

function getSupportedMimeType(): string {
  const types = ['audio/webm;codecs=opus', 'audio/webm', 'audio/ogg;codecs=opus', 'audio/mp4']
  for (const t of types) {
    if (MediaRecorder.isTypeSupported(t)) return t
  }
  return ''
}
</script>

<template>
  <div class="flex flex-col gap-8 relative">
    <BoxContainer ref="containerRef" class="w-full grow">
      <div class="grid gap-4 pb-8">
        <MessageItem
          v-for="item, index in MESSAGES" :key="index"
          :role="item.role" :content="item.content"
          :reasoning="item.reasoning" :sender="item.sender"
          :class="(item.generating && index === MESSAGES.length - 1) || 'border-b'"
        />
      </div>
    </BoxContainer>

    <!-- Session History Panel -->
    <Transition name="slide-up">
      <div v-if="showHistory" class="session-panel">
        <div class="flex items-center justify-between px-3 py-2 border-b border-white/10">
          <span class="text-white/70 text-sm font-bold">å¯¹è¯å†å²</span>
          <button
            class="text-white/40 hover:text-white/80 bg-transparent border-none cursor-pointer text-xs"
            @click="showHistory = false"
          >
            å…³é—­
          </button>
        </div>
        <div class="overflow-y-auto max-h-48">
          <div v-if="loadingSessions" class="text-white/40 text-xs text-center py-4">
            åŠ è½½ä¸­...
          </div>
          <div v-else-if="sessions.length === 0" class="text-white/40 text-xs text-center py-4">
            æš‚æ— å†å²å¯¹è¯
          </div>
          <div
            v-for="s in sessions" :key="s.sessionId"
            class="session-item"
            :class="{ 'bg-white/10': s.sessionId === CURRENT_SESSION_ID }"
            @click="handleSwitchSession(s.sessionId)"
          >
            <div class="flex-1 min-w-0">
              <div class="text-white/80 text-sm truncate">
                {{ s.sessionId.slice(0, 8) }}...
              </div>
              <div class="text-white/40 text-xs">
                {{ formatRelativeTime(s.lastActiveAt) }} Â· {{ s.conversationRounds }} è½®å¯¹è¯
              </div>
            </div>
            <button
              class="text-white/30 hover:text-red-400 bg-transparent border-none cursor-pointer text-xs shrink-0 ml-2"
              title="åˆ é™¤"
              @click.stop="handleDeleteSession(s.sessionId)"
            >
              x
            </button>
          </div>
        </div>
      </div>
    </Transition>

    <div v-if="toolMessage" class="mx-[var(--nav-back-width)] text-white/50 text-xs px-2 py-1">
      {{ toolMessage }}
    </div>
    <div class="mx-[var(--nav-back-width)]">
      <div class="box flex items-center gap-2">
        <button
          class="p-2 text-white/60 hover:text-white bg-transparent border-none cursor-pointer text-sm shrink-0"
          title="æ–°å»ºå¯¹è¯"
          @click="handleNewSession"
        >
          +
        </button>
        <button
          class="p-2 text-white/60 hover:text-white bg-transparent border-none cursor-pointer text-sm shrink-0"
          :class="{ 'text-white!': showHistory }"
          title="å¯¹è¯å†å²"
          @click="toggleHistory"
        >
          H
        </button>
        <input
          v-model="input"
          class="p-2 lh-none text-white w-full bg-transparent border-none outline-none"
          type="text"
          placeholder="Type a message..."
        >
        <button
          class="input-icon-btn shrink-0"
          :class="{ recording: isRecording }"
          :title="isRecording ? 'åœæ­¢å½•éŸ³' : 'è¯­éŸ³è¾“å…¥'"
          @click="toggleVoiceInput"
        >
          <svg v-if="!isRecording" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z" /><path d="M19 10v2a7 7 0 0 1-14 0v-2" /><line x1="12" x2="12" y1="19" y2="22" /></svg>
          <svg v-else xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="6" width="12" height="12" rx="2" /></svg>
        </button>
        <button
          class="input-icon-btn shrink-0"
          title="ä¸Šä¼ æ–‡ä»¶ (Word/Excel/æ–‡æœ¬)"
          @click="triggerUpload"
        >
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z" /><path d="M14 2v4a2 2 0 0 0 2 2h4" /><path d="M12 18v-6" /><path d="m9 15 3-3 3 3" /></svg>
        </button>
        <input
          ref="fileInput"
          type="file"
          accept=".docx,.xlsx,.txt,.csv,.md,.pdf,.png,.jpg,.jpeg"
          class="hidden"
          @change="handleFileUpload"
        >
      </div>
    </div>
  </div>
</template>

<style scoped>
.session-panel {
  position: absolute;
  left: var(--nav-back-width);
  right: 0;
  bottom: 5rem;
  background: rgba(30, 30, 30, 0.95);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  backdrop-filter: blur(12px);
  z-index: 10;
}

.session-item {
  display: flex;
  align-items: center;
  padding: 8px 12px;
  cursor: pointer;
  transition: background 0.15s;
}

.session-item:hover {
  background: rgba(255, 255, 255, 0.05);
}

.slide-up-enter-active,
.slide-up-leave-active {
  transition: all 0.2s ease;
}

.slide-up-enter-from,
.slide-up-leave-to {
  opacity: 0;
  transform: translateY(8px);
}

.input-icon-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  border-radius: 6px;
  background: transparent;
  border: none;
  color: rgba(255, 255, 255, 0.5);
  cursor: pointer;
  transition: color 0.2s, background 0.2s;
}

.input-icon-btn:hover {
  color: rgba(255, 255, 255, 0.9);
  background: rgba(255, 255, 255, 0.08);
}

.input-icon-btn.recording {
  color: #e85d5d;
  animation: recording-pulse 1.2s ease-in-out infinite;
}

@keyframes recording-pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}
</style>
