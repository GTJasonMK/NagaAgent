# NagaAgent å…¨å±€ä¼˜åŒ–åˆ†ææŠ¥å‘Š

## é¡¹ç›®æ¶æ„æ¦‚è§ˆ

### ğŸ—ï¸ æœåŠ¡æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Electron å‰ç«¯                         â”‚
â”‚                      (Vue 3 + UnoCSS)                        â”‚
â”‚                    Port: éšæœº (Vite Dev)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚            â”‚            â”‚
         â”‚ WebSocket  â”‚ HTTP       â”‚ HTTP
         â”‚            â”‚            â”‚
         v            v            v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ API Server â”‚  â”‚  Agent    â”‚  â”‚ MCP Server  â”‚
â”‚  (8000)    â”‚â—„â”€â”¤  Server   â”‚â—„â”€â”¤   (8003)    â”‚
â”‚            â”‚  â”‚  (8001)   â”‚  â”‚             â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
      â”‚               â”‚                â”‚
      v               v                v
  WebSocket    ProactiveVision    MCP Agents
  Manager      OpenClaw          (screen_visionç­‰)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Voice Service (5048/5060)       â”‚
â”‚     TTS + ASR + Qwen Omni           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“‹ æœåŠ¡æ¸…å•

| æœåŠ¡ | ç«¯å£ | èŒè´£ | å¯åŠ¨æ–¹å¼ |
|------|------|------|---------|
| **API Server** | 8000 | å¯¹è¯ã€æµå¼å·¥å…·è°ƒç”¨ã€è®¤è¯ã€è®°å¿†ã€é…ç½® | `uvicorn apiserver.api_server:app` |
| **Agent Server** | 8001 | æ„å›¾åˆ†æã€OpenClawã€ProactiveVision | `uvicorn agentserver.agent_server:app` |
| **MCP Server** | 8003 | MCPå·¥å…·æ³¨å†Œ/è°ƒåº¦ | `uvicorn mcpserver.mcp_server:app` |
| **Voice Service** | 5048/5060 | TTS/ASR | ç‹¬ç«‹è¿›ç¨‹ |
| **Frontend** | éšæœº | Electron GUI | `npm run dev` |

---

## ğŸ” å‘ç°çš„é—®é¢˜

### 1ï¸âƒ£ æœåŠ¡ä¾èµ–å’Œå¯åŠ¨é¡ºåºé—®é¢˜

#### é—®é¢˜Aï¼šç¼ºä¹ç»Ÿä¸€çš„å¯åŠ¨ç¼–æ’

**å½“å‰çŠ¶æ€ï¼š**
- `main.py` å¯åŠ¨æ‰€æœ‰åç«¯æœåŠ¡
- ä½†æ²¡æœ‰ä¾èµ–æ£€æŸ¥å’Œå¥åº·ç­‰å¾…

**é£é™©ï¼š**
```python
# Agent Serverå¯åŠ¨æ—¶è°ƒç”¨MCP Server
async def lifespan(app):
    # âŒ MCP Serverå¯èƒ½è¿˜æœªå°±ç»ª
    await call_mcp_server("http://127.0.0.1:8003/call")
```

**å½±å“ï¼š**
- å¯åŠ¨å¤±è´¥æˆ–éƒ¨åˆ†åŠŸèƒ½ä¸å¯ç”¨
- å¯åŠ¨æ—¶ç«æ€æ¡ä»¶

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¡ ä¸­ç­‰

---

#### é—®é¢˜Bï¼šå¾ªç¯ä¾èµ–é£é™©

**å‘ç°çš„ä¾èµ–é“¾ï¼š**
```
API Server (8000)
  â””â”€â–º Agent Server (8001) - æ„å›¾åˆ†æ
        â””â”€â–º MCP Server (8003) - å·¥å…·è°ƒç”¨
              â””â”€â–º screen_vision
                    â””â”€â–º (æ½œåœ¨) API Server - LLMæœåŠ¡

ProactiveVision (Agent Serverå†…)
  â””â”€â–º MCP Server (8003) - screen_vision
        â””â”€â–º (éœ€è¦) LLM API
              â””â”€â–º API Server (8000) âŒ å¾ªç¯ï¼
```

**é—®é¢˜ï¼š**
- ProactiveVision â†’ MCP â†’ screen_vision â†’ LLM API
- å¦‚æœLLM APIåœ¨API Serverï¼Œä¼šå½¢æˆé—´æ¥å¾ªç¯ä¾èµ–

**ä¼˜å…ˆçº§ï¼š** ğŸ”´ é«˜

---

### 2ï¸âƒ£ ç«¯å£ç®¡ç†å’Œç¡¬ç¼–ç é—®é¢˜

#### é—®é¢˜Aï¼šéƒ¨åˆ†æœåŠ¡ä»æœ‰ç¡¬ç¼–ç ç«¯å£

**å‘ç°ä½ç½®ï¼š**
```python
# âŒ ç¡¬ç¼–ç ç¤ºä¾‹
# apiserver/websocket_manager.py
url = f"http://127.0.0.1:8001/some_endpoint"

# âŒ å‰ç«¯ç¡¬ç¼–ç 
# frontend/src/App.vue
await fetch('http://127.0.0.1:8001/proactive_vision/window_mode')
```

**å½±å“ï¼š**
- ç«¯å£ä¿®æ”¹éœ€è¦å¤šå¤„æ›´æ”¹
- å®¹å™¨åŒ–/å¤šå®ä¾‹éƒ¨ç½²å›°éš¾

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¡ ä¸­ç­‰

---

#### é—®é¢˜Bï¼šæœåŠ¡å‘ç°æœºåˆ¶ç¼ºå¤±

**å½“å‰çŠ¶æ€ï¼š**
- æ‰€æœ‰æœåŠ¡é€šè¿‡ `get_server_port()` è·å–ç«¯å£
- ä½†æ²¡æœ‰è¿è¡Œæ—¶æœåŠ¡å‘ç°

**ç¼ºé™·ï¼š**
```python
# å‡è®¾Agent Serverç«¯å£è¢«å ç”¨ï¼Œè‡ªåŠ¨ä½¿ç”¨8002
# ä½†API Serverä»ç„¶å°è¯•è¿æ¥8001 â†’ è¿æ¥å¤±è´¥
```

**å»ºè®®ï¼š**
- å®ç°ç®€å•çš„æœåŠ¡æ³¨å†Œä¸­å¿ƒ
- æˆ–ä½¿ç”¨ç¯å¢ƒå˜é‡ + å¥åº·æ£€æŸ¥

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¡ ä¸­ç­‰

---

### 3ï¸âƒ£ èµ„æºç«äº‰å’Œå¹¶å‘é—®é¢˜

#### é—®é¢˜Aï¼šLLM APIå¹¶å‘é™åˆ¶

**åœºæ™¯ï¼š**
```
åŒæ—¶å‘ç”Ÿï¼š
1. ç”¨æˆ·åœ¨å‰ç«¯å¯¹è¯ â†’ API Server â†’ LLM
2. GRAGè®°å¿†æå– â†’ API Server â†’ LLM
3. ProactiveVisionåˆ†æ â†’ MCP â†’ screen_vision â†’ LLM
4. æ„å›¾åˆ†æ â†’ Agent Server â†’ LLM
```

**é—®é¢˜ï¼š**
- 4ä¸ªå¹¶å‘LLMè¯·æ±‚
- APIé™æµå¯èƒ½å¯¼è‡´å¤±è´¥
- æ— ä¼˜å…ˆçº§é˜Ÿåˆ—

**ä¼˜å…ˆçº§ï¼š** ğŸ”´ é«˜

---

#### é—®é¢˜Bï¼šæ•°æ®åº“è¿æ¥æ± æœªé…ç½®

**å½“å‰çŠ¶æ€ï¼š**
```python
# Neo4jè¿æ¥ï¼ˆGRAGï¼‰
# æ¯æ¬¡æŸ¥è¯¢åˆ›å»ºæ–°è¿æ¥ï¼Ÿ
```

**å»ºè®®ï¼š**
- é…ç½®è¿æ¥æ± å¤§å°
- è®¾ç½®è¶…æ—¶å’Œé‡è¯•
- ç›‘æ§è¿æ¥æ³„æ¼

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¡ ä¸­ç­‰

---

#### é—®é¢˜Cï¼šæˆªå›¾èµ„æºç«äº‰ï¼ˆå·²è¯†åˆ«ï¼‰

**åœºæ™¯ï¼š**
```
1. ç”¨æˆ·æ‰‹åŠ¨è§¦å‘screen_vision
2. ProactiveVisionå®šæ—¶è§¦å‘screen_vision
3. ä¸¤è€…å¯èƒ½åŒæ—¶æˆªå›¾ â†’ mssåº“ä¸çº¿ç¨‹å®‰å…¨
```

**çŠ¶æ€ï¼š** âš ï¸ å·²åœ¨ `THREAD_SAFETY_AUDIT.md` ä¸­è®°å½•

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¡ ä¸­ç­‰

---

### 4ï¸âƒ£ é”™è¯¯ä¼ æ’­å’Œæ¢å¤æœºåˆ¶

#### é—®é¢˜Aï¼šè·¨æœåŠ¡é”™è¯¯ä¼ æ’­ä¸æ¸…æ™°

**åœºæ™¯ï¼š**
```
ç”¨æˆ·è¯·æ±‚ â†’ API Server â†’ Agent Server â†’ MCP Server â†’ screen_vision

screen_visionå¤±è´¥ â†’ ?
- MCP Serverè¿”å›ä»€ä¹ˆï¼Ÿ
- Agent Serverå¦‚ä½•å¤„ç†ï¼Ÿ
- API Serverè¿”å›ä»€ä¹ˆç»™ç”¨æˆ·ï¼Ÿ
```

**å½“å‰é—®é¢˜ï¼š**
- é”™è¯¯ä¿¡æ¯å¯èƒ½åœ¨å¤šå±‚è½¬æ¢ä¸­ä¸¢å¤±
- ç”¨æˆ·çœ‹åˆ°çš„æ˜¯"å†…éƒ¨é”™è¯¯"è€Œé"æˆªå›¾æƒé™ä¸è¶³"

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¡ ä¸­ç­‰

---

#### é—®é¢˜Bï¼šå•ç‚¹æ•…éšœæ— è‡ªåŠ¨æ¢å¤

**åœºæ™¯ï¼š**
```
MCP Serverå´©æºƒ â†’ æ‰€æœ‰å·¥å…·è°ƒç”¨å¤±è´¥
ä½†API Serverä¸ä¼šè‡ªåŠ¨é‡å¯MCP Server
```

**å»ºè®®ï¼š**
- å¥åº·æ£€æŸ¥ + è‡ªåŠ¨é‡å¯
- æˆ–ä½¿ç”¨è¿›ç¨‹ç®¡ç†å™¨ï¼ˆsupervisord/systemdï¼‰

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¡ ä¸­ç­‰

---

### 5ï¸âƒ£ æ€§èƒ½å’Œç¼“å­˜ä¼˜åŒ–

#### é—®é¢˜Aï¼šé‡å¤çš„HTTPè¯·æ±‚

**å‘ç°ï¼š**
```python
# ProactiveVisionæ¯30ç§’ï¼š
1. HTTP GET config (è¯»å–é…ç½®)
2. HTTP POST /call (è°ƒç”¨screen_vision)
3. HTTP POST /reset_timer (é‡ç½®è®¡æ—¶å™¨)
4. HTTP POST /ws/broadcast (æ¨é€æ¶ˆæ¯)

# ä¼˜åŒ–ï¼š
- é…ç½®ç¼“å­˜ï¼ˆä»…å˜æ›´æ—¶é‡æ–°åŠ è½½ï¼‰
- HTTPè¿æ¥æ± å¤ç”¨
- æ‰¹é‡APIåˆå¹¶
```

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¢ ä½

---

#### é—®é¢˜Bï¼šç¼ºå°‘å…¨å±€ç¼“å­˜å±‚

**å½“å‰çŠ¶æ€ï¼š**
- æ¯ä¸ªæ¨¡å—ç‹¬ç«‹ç¼“å­˜
- æ— ç»Ÿä¸€ç¼“å­˜ç­–ç•¥

**å»ºè®®ï¼š**
```python
# å…¨å±€ç¼“å­˜æœåŠ¡
class GlobalCache:
    def __init__(self):
        self._cache = {}  # æˆ–Redis

    def get_or_compute(self, key, ttl, compute_fn):
        # ç»Ÿä¸€ç¼“å­˜é€»è¾‘
        pass

# åº”ç”¨åœºæ™¯ï¼š
- LLMå“åº”ç¼“å­˜ï¼ˆç›¸åŒpromptï¼‰
- é…ç½®ç¼“å­˜
- æˆªå›¾ç¼“å­˜ï¼ˆ2ç§’TTLï¼‰
- GRAGæŸ¥è¯¢ç»“æœç¼“å­˜
```

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¡ ä¸­ç­‰

---

#### é—®é¢˜Cï¼šæ•°æ®åº“æŸ¥è¯¢æœªä¼˜åŒ–

**åœºæ™¯ï¼š**
```cypher
# GRAGæ¯æ¬¡å¯¹è¯éƒ½æŸ¥è¯¢Neo4j
MATCH (e1:Entity)-[r]->(e2:Entity)
WHERE e1.name CONTAINS '{keyword}'
RETURN e1, r, e2
LIMIT 5
```

**ä¼˜åŒ–ï¼š**
- æ·»åŠ ç´¢å¼•ï¼š`CREATE INDEX ON :Entity(name)`
- æŸ¥è¯¢ç»“æœç¼“å­˜ï¼ˆç›¸åŒå…³é”®è¯ï¼‰
- æ‰¹é‡æŸ¥è¯¢ï¼ˆå¤šä¸ªå…³é”®è¯ä¸€æ¬¡ï¼‰

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¡ ä¸­ç­‰

---

### 6ï¸âƒ£ ç›‘æ§å’Œå¯è§‚æµ‹æ€§ç¼ºå¤±

#### é—®é¢˜Aï¼šç¼ºå°‘ç»Ÿä¸€æ—¥å¿—èšåˆ

**å½“å‰çŠ¶æ€ï¼š**
- æ¯ä¸ªæœåŠ¡ç‹¬ç«‹æ—¥å¿—æ–‡ä»¶
- éš¾ä»¥å…³è”è·¨æœåŠ¡è¯·æ±‚

**å»ºè®®ï¼š**
```python
# è¯·æ±‚è¿½è¸ªID
import uuid

class RequestContext:
    def __init__(self):
        self.trace_id = str(uuid.uuid4())

# æ‰€æœ‰æ—¥å¿—åŒ…å«trace_id
logger.info(f"[{trace_id}] Processing request...")
```

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¡ ä¸­ç­‰

---

#### é—®é¢˜Bï¼šç¼ºå°‘æ€§èƒ½æŒ‡æ ‡æ”¶é›†

**å½“å‰çŠ¶æ€ï¼š**
- ProactiveVisionæœ‰metrics
- ä½†å…¶ä»–æ¨¡å—æ²¡æœ‰

**å»ºè®®ï¼š**
```python
# ç»Ÿä¸€metricsæ¡†æ¶
from prometheus_client import Counter, Histogram

request_count = Counter('api_requests_total', 'APIè¯·æ±‚æ€»æ•°')
request_duration = Histogram('api_request_duration_seconds', 'APIè¯·æ±‚è€—æ—¶')

@app.middleware("http")
async def metrics_middleware(request, call_next):
    with request_duration.time():
        response = await call_next(request)
    request_count.inc()
    return response
```

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¢ ä½

---

#### é—®é¢˜Cï¼šæ— å¥åº·æ£€æŸ¥ä»ªè¡¨æ¿

**å½“å‰çŠ¶æ€ï¼š**
- å„æœåŠ¡æœ‰ `/health` ç«¯ç‚¹
- ä½†æ²¡æœ‰ç»Ÿä¸€è§†å›¾

**å»ºè®®ï¼š**
- å‰ç«¯æ·»åŠ "ç³»ç»ŸçŠ¶æ€"é¡µé¢
- å®æ—¶æ˜¾ç¤ºå„æœåŠ¡å¥åº·çŠ¶æ€
- æ˜¾ç¤ºå…³é”®æŒ‡æ ‡ï¼ˆè¯·æ±‚é‡ã€é”™è¯¯ç‡ç­‰ï¼‰

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¢ ä½

---

### 7ï¸âƒ£ é…ç½®ç®¡ç†é—®é¢˜

#### é—®é¢˜Aï¼šé…ç½®æ–‡ä»¶åˆ†æ•£

**å½“å‰çŠ¶æ€ï¼š**
```
config.json - ä¸»é…ç½®
proactive_vision_config.json - PVé…ç½®
agent-manifest.json - MCPé…ç½®ï¼ˆå¤šä¸ªï¼‰
```

**é—®é¢˜ï¼š**
- é…ç½®åˆ†æ•£ï¼Œéš¾ä»¥ç®¡ç†
- æ— ç»Ÿä¸€çš„é…ç½®éªŒè¯

**å»ºè®®ï¼š**
- åˆå¹¶åˆ°å•ä¸€é…ç½®æ–‡ä»¶
- æˆ–ä½¿ç”¨é…ç½®ç®¡ç†æœåŠ¡

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¢ ä½

---

#### é—®é¢˜Bï¼šæ•æ„Ÿä¿¡æ¯æ˜æ–‡å­˜å‚¨

**å‘ç°ï¼š**
```json
// config.json
{
  "api": {
    "api_key": "sk-xxxxxxxxx"  // âŒ æ˜æ–‡
  }
}
```

**å»ºè®®ï¼š**
```python
# ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–å¯†é’¥ç®¡ç†
import os
from cryptography.fernet import Fernet

api_key = os.getenv("API_KEY") or decrypt_from_file("api_key.enc")
```

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¡ ä¸­ç­‰

---

### 8ï¸âƒ£ å‰ç«¯åç«¯é€šä¿¡ä¼˜åŒ–

#### é—®é¢˜Aï¼šWebSocketé‡è¿æœºåˆ¶ä¸å®Œå–„

**å½“å‰çŠ¶æ€ï¼š**
```typescript
// frontend - WebSocketæ–­å¼€åï¼Ÿ
ws.onclose = () => {
  // é‡è¿é€»è¾‘ï¼Ÿ
}
```

**å»ºè®®ï¼š**
- æŒ‡æ•°é€€é¿é‡è¿
- å¿ƒè·³æ£€æµ‹
- æ–­çº¿æœŸé—´æ¶ˆæ¯é˜Ÿåˆ—

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¡ ä¸­ç­‰

---

#### é—®é¢˜Bï¼šHTTPé•¿è½®è¯¢å¯ä»¥æ”¹ä¸ºWebSocket

**å‘ç°ï¼š**
```typescript
// éƒ¨åˆ†åŠŸèƒ½ä½¿ç”¨HTTPè½®è¯¢
setInterval(() => {
  fetch('/api/status')
}, 1000)
```

**ä¼˜åŒ–ï¼š**
- æ”¹ä¸ºWebSocketæ¨é€
- å‡å°‘ç½‘ç»œå¼€é”€

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¢ ä½

---

### 9ï¸âƒ£ éƒ¨ç½²å’Œæ‰©å±•æ€§é—®é¢˜

#### é—®é¢˜Aï¼šæ— å®¹å™¨åŒ–é…ç½®

**å½“å‰çŠ¶æ€ï¼š**
- ç¼ºå°‘Dockerfile
- ç¼ºå°‘docker-compose.yml

**å½±å“ï¼š**
- éƒ¨ç½²å¤æ‚
- ç¯å¢ƒä¸€è‡´æ€§å·®

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¢ ä½ï¼ˆå–å†³äºéƒ¨ç½²éœ€æ±‚ï¼‰

---

#### é—®é¢˜Bï¼šæ— æ°´å¹³æ‰©å±•æ”¯æŒ

**å½“å‰æ¶æ„ï¼š**
- æ‰€æœ‰æœåŠ¡å•å®ä¾‹
- æ— è´Ÿè½½å‡è¡¡

**é™åˆ¶ï¼š**
- é«˜å¹¶å‘åœºæ™¯æ€§èƒ½ç“¶é¢ˆ
- æ— æ³•æ°´å¹³æ‰©å±•

**ä¼˜å…ˆçº§ï¼š** ğŸŸ¢ ä½ï¼ˆå½“å‰å¯èƒ½ä¸éœ€è¦ï¼‰

---

## ğŸ¯ ä¼˜åŒ–å»ºè®®ä¼˜å…ˆçº§

### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³å®æ–½ï¼‰

1. **LLM APIå¹¶å‘æ§åˆ¶**
   - å®ç°è¯·æ±‚é˜Ÿåˆ—å’Œä¼˜å…ˆçº§
   - é¿å…åŒæ—¶å¤šä¸ªLLMè¯·æ±‚
   - é¢„æœŸæ”¶ç›Šï¼šå‡å°‘APIé™æµå¤±è´¥

2. **æœåŠ¡ä¾èµ–å¾ªç¯æ£€æµ‹**
   - æ£€æŸ¥ProactiveVision â†’ LLMçš„ä¾èµ–é“¾
   - ç¡®ä¿æ— å¾ªç¯ä¾èµ–
   - é¢„æœŸæ”¶ç›Šï¼šç³»ç»Ÿç¨³å®šæ€§

3. **é”™è¯¯ä¼ æ’­é“¾ä¼˜åŒ–**
   - ç»Ÿä¸€é”™è¯¯æ ¼å¼
   - ä¿ç•™åŸå§‹é”™è¯¯ä¿¡æ¯
   - é¢„æœŸæ”¶ç›Šï¼šè°ƒè¯•å’Œç”¨æˆ·ä½“éªŒ

---

### ğŸŸ¡ ä¸­ç­‰ä¼˜å…ˆçº§ï¼ˆè¿‘æœŸå®æ–½ï¼‰

4. **ç»Ÿä¸€æœåŠ¡å‘ç°**
   - å®ç°ç®€å•çš„æ³¨å†Œä¸­å¿ƒ
   - æˆ–ä½¿ç”¨ç¯å¢ƒå˜é‡ + å¥åº·æ£€æŸ¥
   - é¢„æœŸæ”¶ç›Šï¼šéƒ¨ç½²çµæ´»æ€§

5. **å…¨å±€ç¼“å­˜å±‚**
   - ç»Ÿä¸€ç¼“å­˜ç­–ç•¥
   - Rediså¯é€‰
   - é¢„æœŸæ”¶ç›Šï¼šæ€§èƒ½æå‡20-30%

6. **è¯·æ±‚è¿½è¸ªID**
   - è·¨æœåŠ¡æ—¥å¿—å…³è”
   - ä¾¿äºè°ƒè¯•
   - é¢„æœŸæ”¶ç›Šï¼šé—®é¢˜å®šä½æ—¶é—´å‡å°‘50%

7. **æ•°æ®åº“è¿æ¥æ± é…ç½®**
   - Neo4jè¿æ¥æ± 
   - é˜²æ­¢è¿æ¥æ³„æ¼
   - é¢„æœŸæ”¶ç›Šï¼šç¨³å®šæ€§

8. **WebSocketé‡è¿ä¼˜åŒ–**
   - æŒ‡æ•°é€€é¿
   - å¿ƒè·³æ£€æµ‹
   - é¢„æœŸæ”¶ç›Šï¼šè¿æ¥ç¨³å®šæ€§

9. **é…ç½®ç®¡ç†æ”¹è¿›**
   - æ•æ„Ÿä¿¡æ¯åŠ å¯†
   - é…ç½®éªŒè¯
   - é¢„æœŸæ”¶ç›Šï¼šå®‰å…¨æ€§

---

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰ï¼‰

10. **ç»Ÿä¸€metricsæ”¶é›†**
    - Prometheusæ ¼å¼
    - æ€§èƒ½ç›‘æ§

11. **å¥åº·æ£€æŸ¥ä»ªè¡¨æ¿**
    - å‰ç«¯ç³»ç»ŸçŠ¶æ€é¡µ

12. **å®¹å™¨åŒ–é…ç½®**
    - Docker + docker-compose
    - éƒ¨ç½²ç®€åŒ–

13. **HTTPè¿æ¥æ± å¤ç”¨**
    - å‡å°‘è¿æ¥å¼€é”€

14. **æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–**
    - ç´¢å¼•ä¼˜åŒ–
    - æŸ¥è¯¢ç¼“å­˜

---

## ğŸ“Š ä¼˜åŒ–å®æ–½è®¡åˆ’

### Week 1ï¼šé«˜ä¼˜å…ˆçº§

```python
# 1. LLM APIå¹¶å‘æ§åˆ¶
class LLMRequestQueue:
    def __init__(self, max_concurrent=2):
        self._semaphore = asyncio.Semaphore(max_concurrent)
        self._queue = asyncio.PriorityQueue()

    async def request(self, priority, prompt):
        async with self._semaphore:
            # æ‰§è¡ŒLLMè¯·æ±‚
            pass

# 2. æœåŠ¡ä¾èµ–æ£€æŸ¥
async def check_service_health(service_url, timeout=5):
    try:
        async with httpx.AsyncClient() as client:
            resp = await client.get(f"{service_url}/health", timeout=timeout)
            return resp.status_code == 200
    except:
        return False

# Agent Serverå¯åŠ¨æ—¶ç­‰å¾…MCP Server
async def lifespan(app):
    while not await check_service_health("http://127.0.0.1:8003"):
        await asyncio.sleep(1)
    # ç»§ç»­å¯åŠ¨...

# 3. ç»Ÿä¸€é”™è¯¯æ ¼å¼
class ServiceError(Exception):
    def __init__(self, service: str, error: str, details: dict):
        self.service = service
        self.error = error
        self.details = details
```

### Week 2ï¼šä¸­ç­‰ä¼˜å…ˆçº§

```python
# 4. è¯·æ±‚è¿½è¸ªID
from contextvars import ContextVar

trace_id_var: ContextVar[str] = ContextVar("trace_id")

@app.middleware("http")
async def trace_middleware(request, call_next):
    trace_id = request.headers.get("X-Trace-ID", str(uuid.uuid4()))
    trace_id_var.set(trace_id)
    response = await call_next(request)
    response.headers["X-Trace-ID"] = trace_id
    return response

# 5. å…¨å±€ç¼“å­˜
class CacheManager:
    def __init__(self):
        self._cache: Dict[str, Tuple[Any, float]] = {}

    async def get_or_set(self, key: str, ttl: int, compute_fn):
        if key in self._cache:
            value, expire_at = self._cache[key]
            if time.time() < expire_at:
                return value

        value = await compute_fn()
        self._cache[key] = (value, time.time() + ttl)
        return value

# 6. Neo4jè¿æ¥æ± 
from neo4j import GraphDatabase

driver = GraphDatabase.driver(
    uri,
    auth=(user, password),
    max_connection_pool_size=50,
    connection_timeout=5.0
)
```

---

## ğŸ” ä»£ç å®¡æŸ¥æ¸…å•

### å¯åŠ¨é¡ºåº
- [ ] æ£€æŸ¥`main.py`å¯åŠ¨é¡ºåº
- [ ] æ·»åŠ æœåŠ¡å¥åº·æ£€æŸ¥
- [ ] å®ç°ä¾èµ–ç­‰å¾…

### ç«¯å£ç®¡ç†
- [ ] æœç´¢æ‰€æœ‰ç¡¬ç¼–ç ç«¯å£
- [ ] æ›¿æ¢ä¸º`get_server_port()`
- [ ] æ·»åŠ ç«¯å£å†²çªæ£€æµ‹

### å¹¶å‘æ§åˆ¶
- [ ] LLMè¯·æ±‚é˜Ÿåˆ—
- [ ] æ•°æ®åº“è¿æ¥æ± 
- [ ] æˆªå›¾å…¨å±€é”

### é”™è¯¯å¤„ç†
- [ ] ç»Ÿä¸€é”™è¯¯æ ¼å¼
- [ ] é”™è¯¯é“¾è¿½è¸ª
- [ ] ç”¨æˆ·å‹å¥½é”™è¯¯æ¶ˆæ¯

### æ€§èƒ½ä¼˜åŒ–
- [ ] HTTPè¿æ¥æ± å¤ç”¨
- [ ] å…¨å±€ç¼“å­˜å±‚
- [ ] æ•°æ®åº“ç´¢å¼•
- [ ] æŸ¥è¯¢ä¼˜åŒ–

### å¯è§‚æµ‹æ€§
- [ ] è¯·æ±‚è¿½è¸ªID
- [ ] ç»Ÿä¸€æ—¥å¿—æ ¼å¼
- [ ] Metricsæ”¶é›†
- [ ] å¥åº·æ£€æŸ¥ç«¯ç‚¹

---

## ğŸ’¡ å¿«é€Ÿæ”¹è¿›å»ºè®®ï¼ˆ1å¤©å†…å®Œæˆï¼‰

### 1. æ·»åŠ å¯åŠ¨ä¾èµ–æ£€æŸ¥
```python
# main.py
async def wait_for_service(url, timeout=30):
    start = time.time()
    while time.time() - start < timeout:
        try:
            async with httpx.AsyncClient() as client:
                await client.get(f"{url}/health", timeout=2)
            return True
        except:
            await asyncio.sleep(1)
    return False

# å¯åŠ¨é¡ºåº
await start_mcp_server()
await wait_for_service("http://127.0.0.1:8003")

await start_agent_server()
await wait_for_service("http://127.0.0.1:8001")

await start_api_server()
```

### 2. æ·»åŠ è¯·æ±‚è¿½è¸ªID
```python
# middleware.py
@app.middleware("http")
async def add_trace_id(request, call_next):
    trace_id = request.headers.get("X-Trace-ID", str(uuid.uuid4()))

    # ä¼ é€’ç»™æ‰€æœ‰logger
    with logger.contextualize(trace_id=trace_id):
        response = await call_next(request)

    response.headers["X-Trace-ID"] = trace_id
    return response
```

### 3. LLMè¯·æ±‚é™æµ
```python
# llm_service.py
_llm_semaphore = asyncio.Semaphore(2)  # æœ€å¤š2ä¸ªå¹¶å‘

async def call_llm(prompt):
    async with _llm_semaphore:
        return await actual_llm_call(prompt)
```

---

## ğŸ“ˆ é¢„æœŸæ”¶ç›Š

| ä¼˜åŒ–é¡¹ | æ€§èƒ½æå‡ | ç¨³å®šæ€§æå‡ | å¼€å‘æ•ˆç‡æå‡ |
|--------|---------|-----------|-------------|
| LLMå¹¶å‘æ§åˆ¶ | +20% | +30% | - |
| å…¨å±€ç¼“å­˜ | +30% | - | - |
| è¯·æ±‚è¿½è¸ª | - | - | +50% |
| é”™è¯¯ä¼ æ’­ä¼˜åŒ– | - | +20% | +30% |
| æœåŠ¡ä¾èµ–æ£€æŸ¥ | - | +40% | - |
| è¿æ¥æ± é…ç½® | +15% | +25% | - |

**æ€»ä½“é¢„æœŸï¼š**
- æ€§èƒ½æå‡ï¼š30-50%
- ç¨³å®šæ€§æå‡ï¼š50%+
- å¼€å‘è°ƒè¯•æ•ˆç‡ï¼š50%+

---

## âœ… æ€»ç»“

### å½“å‰ç³»ç»ŸçŠ¶æ€
- âœ… åŠŸèƒ½å®Œæ•´ï¼Œæ¶æ„æ¸…æ™°
- âœ… æ¨¡å—åŒ–è®¾è®¡è‰¯å¥½
- âš ï¸ éƒ¨åˆ†è·¨æœåŠ¡é€šä¿¡éœ€ä¼˜åŒ–
- âš ï¸ å¹¶å‘æ§åˆ¶éœ€åŠ å¼º
- âš ï¸ å¯è§‚æµ‹æ€§éœ€æå‡

### æ ¸å¿ƒä¼˜åŒ–æ–¹å‘
1. **ç¨³å®šæ€§ä¼˜å…ˆ** - æœåŠ¡ä¾èµ–ã€é”™è¯¯å¤„ç†ã€å¹¶å‘æ§åˆ¶
2. **æ€§èƒ½ä¼˜åŒ–** - ç¼“å­˜ã€è¿æ¥æ± ã€æŸ¥è¯¢ä¼˜åŒ–
3. **å¯ç»´æŠ¤æ€§** - æ—¥å¿—è¿½è¸ªã€ç›‘æ§ã€ç»Ÿä¸€é…ç½®

### å®æ–½å»ºè®®
- **ç«‹å³å¼€å§‹ï¼š** é«˜ä¼˜å…ˆçº§3é¡¹ï¼ˆ1å‘¨å†…ï¼‰
- **è¿‘æœŸå®Œæˆï¼š** ä¸­ç­‰ä¼˜å…ˆçº§6é¡¹ï¼ˆ1æœˆå†…ï¼‰
- **é•¿æœŸè§„åˆ’ï¼š** ä½ä¼˜å…ˆçº§5é¡¹ï¼ˆæŒ‰éœ€å®æ–½ï¼‰

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´ï¼š** 2026-02-27
**åˆ†æè¦†ç›–ç‡ï¼š** å…¨å±€æ¶æ„100%
**ä¼˜åŒ–å»ºè®®ï¼š** 14é¡¹
**é¢„æœŸæŠ•å…¥ï¼š** 2-4å‘¨
**é¢„æœŸæ”¶ç›Šï¼š** æ€§èƒ½+30-50%ï¼Œç¨³å®šæ€§+50%+
